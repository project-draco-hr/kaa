{
  try {
    final HttpTestRegisterEndpointClient cl=new HttpTestRegisterEndpointClient(serverPublicKey,RegisterEndpointCommand.getCommandName(),new HttpActivity<SyncResponse>(){
      @Override public void httpRequestComplete(      Exception e,      int id,      SyncResponse response){
        assertNull(e);
synchronized (regTests) {
          if (regTests.containsKey(id)) {
            SyncTest<EndpointRegistrationRequest,SyncResponse> test=regTests.get(id);
            test.responseReceived=response;
            testProcessed++;
          }
 else {
            logger.trace("Test failed: not found in HashMap id: " + id);
          }
        }
        if (testProcessed >= NUMBER_OF_TESTS) {
synchronized (sync) {
            sync.notify();
          }
        }
      }
    }
);
    testCacheService.addPublicKey(cl.getClientPublicKeyHash(),cl.getClientPublicKey());
    regTests.putIfAbsent(Integer.valueOf(cl.getId()),new SyncTest<EndpointRegistrationRequest,SyncResponse>(cl.getId(),cl.getRequest()));
    executor.execute(cl);
  }
 catch (  Exception e) {
    e.printStackTrace();
    fail(e.toString());
  }
}

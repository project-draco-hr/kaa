{
  BaseLogEventPack logPack=message.getLogEventPack();
  LogSchema logSchema=logPack.getLogSchema();
  if (logSchema == null) {
    logSchema=logSchemas.get(message.getLogSchemaVersion());
    if (logSchema == null) {
      logSchema=logAppenderService.getLogSchema(applicationId,logPack.getLogSchemaVersion());
      logSchemas.put(message.getLogSchemaVersion(),logSchema);
    }
    logPack.setLogSchema(logSchema);
  }
  EndpointProfileDataDto profileDto=logPack.getProfileDto();
  ProfileInfo clientProfile=logPack.getClientProfile();
  if (clientProfile == null) {
    AppVersionKey key=new AppVersionKey(applicationToken,profileDto.getClientProfileSchemaVersion());
    BaseSchemaInfo schemaInfo=clientProfileSchemas.get(key);
    if (schemaInfo == null) {
      ProfileSchemaDto schemaDto=cacheService.getProfileSchemaByAppAndVersion(key);
      schemaInfo=new BaseSchemaInfo(schemaDto.getId(),schemaDto.getSchema());
      clientProfileSchemas.put(key,schemaInfo);
    }
    logPack.setClientProfile(new BaseProfileInfo(schemaInfo,profileDto.getClientProfileBody()));
  }
  ProfileInfo serverProfile=logPack.getServerProfile();
  if (serverProfile == null && profileDto.getServerProfileCtlSchemaId() != null) {
    BaseSchemaInfo schemaInfo=serverProfileSchemas.get(profileDto.getServerProfileCtlSchemaId());
    if (schemaInfo == null) {
      CTLSchemaDto ctlSchemaDto=cacheService.getCtlSchemaById(profileDto.getServerProfileCtlSchemaId());
      String schema=ctlService.flatExportAsString(ctlSchemaDto);
      schemaInfo=new BaseSchemaInfo(ctlSchemaDto.getId(),schema);
      serverProfileSchemas.put(profileDto.getServerProfileCtlSchemaId(),schemaInfo);
    }
    logPack.setServerProfile(new BaseProfileInfo(schemaInfo,profileDto.getServerProfileBody()));
  }
}

{
  ChannelHandlerContext channelContextMock=Mockito.mock(ChannelHandlerContext.class);
  EndpointProfileDto sourceProfileMock=Mockito.mock(EndpointProfileDto.class);
  EventClassFamilyVersionStateDto ecfVdto=new EventClassFamilyVersionStateDto();
  ecfVdto.setEcfId(ECF1_ID);
  ecfVdto.setVersion(ECF1_VERSION);
  Event event=new Event(0,FQN1,ByteBuffer.wrap(new byte[0]),Base64Util.encode(clientPublicKeyHash.array()),null);
  SyncRequest sourceRequest=new SyncRequest();
  SyncRequestMetaData md=new SyncRequestMetaData();
  md.setApplicationToken(APP_TOKEN);
  md.setEndpointPublicKeyHash(clientPublicKeyHash);
  md.setTimeout(TIMEOUT * 1L);
  sourceRequest.setSyncRequestMetaData(md);
  EventSyncRequest eventRequest=new EventSyncRequest();
  eventRequest.setEvents(Arrays.asList(event));
  sourceRequest.setEventSyncRequest(eventRequest);
  ServerSync sourceResponse=new ServerSync();
  sourceResponse.setStatus(org.kaaproject.kaa.server.operations.pojo.sync.SyncStatus.SUCCESS);
  SyncResponseHolder sourceResponseHolder=new SyncResponseHolder(sourceResponse);
  sourceResponseHolder.setEndpointProfile(sourceProfileMock);
  when(operationsService.sync(AvroEncDec.convert(sourceRequest),null)).thenReturn(sourceResponseHolder);
  when(sourceProfileMock.getEndpointUserId()).thenReturn(USER_ID);
  when(sourceProfileMock.getEndpointKeyHash()).thenReturn(clientPublicKeyHash.array());
  when(sourceProfileMock.getEcfVersionStates()).thenReturn(Arrays.asList(ecfVdto));
  when(cacheService.getEventClassFamilyIdByEventClassFqn(new EventClassFqnKey(TENANT_ID,FQN1))).thenReturn(ECF1_ID);
  RouteTableKey routeKey=new RouteTableKey(APP_TOKEN,new EventClassFamilyVersion(ECF1_ID,ECF1_VERSION));
  when(cacheService.getRouteKeys(new EventClassFqnVersion(TENANT_ID,FQN1,ECF1_VERSION))).thenReturn(Collections.singleton(routeKey));
  Assert.assertNotNull(akkaService.getActorSystem());
  ResponseBuilder responseBuilder=Mockito.mock(ResponseBuilder.class);
  ErrorBuilder errorBuilder=Mockito.mock(ErrorBuilder.class);
  MessageEncoderDecoder sourceCrypt=new MessageEncoderDecoder(clientPair.getPrivate(),clientPair.getPublic(),serverPair.getPublic());
  SessionInitRequest sourceMessage=toSignedRequest(UUID.randomUUID(),ChannelType.HTTP_LP,channelContextMock,sourceRequest,responseBuilder,errorBuilder,sourceCrypt);
  akkaService.process(sourceMessage);
  Mockito.verify(operationsService,Mockito.timeout(TIMEOUT).atLeastOnce()).sync(Mockito.any(ClientSync.class),Mockito.any(EndpointProfileDto.class));
  UserRouteInfo userRouteInfo=new UserRouteInfo(TENANT_ID,USER_ID,SERVER2,RouteOperation.ADD);
  akkaService.getListener().onUserRouteInfo(userRouteInfo);
  RouteTableAddress remoteAddress=new RouteTableAddress(EndpointObjectHash.fromBytes(targetPublicKeyHash.array()),APP_TOKEN,SERVER2);
  RouteInfo routeInfo=new RouteInfo(TENANT_ID,USER_ID,remoteAddress,Arrays.asList(new EventClassFamilyVersion(ECF1_ID,ECF1_VERSION)));
  TimeUnit.SECONDS.sleep(2);
  akkaService.getListener().onRouteInfo(routeInfo);
  Mockito.verify(eventService,Mockito.timeout(TIMEOUT).atLeastOnce()).sendEvent(Mockito.any(RemoteEndpointEvent.class));
}

{
  String accessToken=config.getAppId() + "|" + config.getAppSecret();
  LOG.trace("Started token verification with accessToken [{}]",accessToken);
  HttpURLConnection connection=null;
  BufferedReader reader=null;
  try {
    connection=establishConnection(userAccessToken,accessToken);
    LOG.trace("Connection established [{}]",accessToken);
    ObjectMapper responseMapper=new ObjectMapper();
    if (connection.getResponseCode() == 400) {
      reader=new BufferedReader(new InputStreamReader(connection.getErrorStream()));
      Map<String,Object> responseMap=responseMapper.readValue(reader.readLine(),Map.class);
      Map<String,Object> errorMap=null;
      if (responseMap.get("error") != null) {
        errorMap=(Map<String,Object>)responseMap.get("error");
      }
      if (errorMap != null && String.valueOf(errorMap.get("code")).equals("190")) {
        if (errorMap.get("error_subcode") == null) {
          LOG.trace("OAuthException: [{}], errcode: [{}], errsubcode: [{}] ",errorMap.get("message"),errorMap.get("errcode"),errorMap.get("error_subcode"));
          callback.onVerificationFailure("OAuthException:" + errorMap.get("message"));
        }
 else         if (String.valueOf(errorMap.get("error_subcode")).equals("463")) {
          LOG.trace("Access Token has expired");
          callback.onTokenExpired();
        }
 else         if (String.valueOf(errorMap.get("error_subcode")).equals("467")) {
          LOG.trace("Access Token is invalid");
          callback.onTokenInvalid();
        }
 else {
          LOG.trace("OAuthException: [{}], errcode: [{}], errsubcode: [{}] ",errorMap.get("message"),errorMap.get("errcode"),errorMap.get("error_subcode"));
          callback.onVerificationFailure("OAuthException:" + errorMap.get("message"));
        }
      }
 else {
        if (errorMap != null) {
          LOG.trace("Unable to verify token: {}, errcode: [{}]",errorMap.get("message"),errorMap.get("errcode"));
          callback.onVerificationFailure("Unable to verify token: " + errorMap.get("message") + ", errorcode: "+ errorMap.get("errcode"));
        }
 else {
          LOG.trace("Unable to verify token. HTTP response 400");
          callback.onVerificationFailure("Unable to verify token. HTTP response 400");
        }
      }
    }
 else     if (connection.getResponseCode() == 200) {
      reader=new BufferedReader(new InputStreamReader(connection.getInputStream()));
      Map<String,Object> responseMap=responseMapper.readValue(reader.readLine(),Map.class);
      Map<String,Object> dataMap=(Map<String,Object>)responseMap.get("data");
      String receivedUserId=String.valueOf(dataMap.get("user_id"));
      if (dataMap.containsKey("error") || receivedUserId == null) {
        Map<String,Object> errorMap=(Map<String,Object>)dataMap.get("error");
        LOG.trace("Bad input token: {}, errcode = {}",errorMap.get("message"),errorMap.get("code"));
        callback.onTokenInvalid();
      }
 else       if (!receivedUserId.equals(userExternalId)) {
        LOG.trace("Input token doesn't belong to the user with {} id",userExternalId);
        callback.onVerificationFailure("User access token " + userAccessToken + " doesn't belong to the user");
      }
 else {
        LOG.trace("Input token is confirmed and belongs to the user with {} id",userExternalId);
        callback.onSuccess();
      }
    }
 else {
      LOG.trace("Server response code: {}, no data can be retrieved",connection.getResponseCode());
      callback.onVerificationFailure("Server response code:" + connection.getResponseCode() + ", no data can be retrieved");
    }
  }
 catch (  MalformedURLException e) {
    LOG.debug("Internal error",e);
    callback.onInternalError(e.getMessage());
  }
catch (  IOException e) {
    LOG.debug("Connection error",e);
    callback.onConnectionError(e.getMessage());
  }
catch (  Exception e) {
    LOG.debug("Unexpected error",e);
    callback.onInternalError(e.getMessage());
  }
 finally {
    if (connection != null)     connection.disconnect();
    if (reader != null) {
      try {
        reader.close();
      }
 catch (      IOException e) {
        LOG.debug("Reader can't be closed",e);
      }
    }
  }
}

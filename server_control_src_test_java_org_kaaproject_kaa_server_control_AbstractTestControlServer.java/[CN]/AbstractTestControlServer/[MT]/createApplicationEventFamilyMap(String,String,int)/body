{
  ApplicationEventFamilyMapDto applicationEventFamilyMap=new ApplicationEventFamilyMapDto();
  String tenantId=null;
  if (strIsEmpty(applicationId)) {
    ApplicationDto application=createApplication();
    tenantId=application.getTenantId();
    applicationEventFamilyMap.setApplicationId(application.getId());
  }
 else {
    applicationEventFamilyMap.setApplicationId(applicationId);
    ApplicationDto application=toDto(client.getApplication(applicationId));
    tenantId=application.getTenantId();
  }
  EventClassFamilyDto eventClassFamily=null;
  if (strIsEmpty(ecfId)) {
    eventClassFamily=createEventClassFamily(tenantId);
  }
 else {
    eventClassFamily=toDto(client.getEventClassFamily(ecfId));
  }
  applicationEventFamilyMap.setEcfId(eventClassFamily.getId());
  applicationEventFamilyMap.setEcfName(eventClassFamily.getName());
  if (eventClassFamily.getSchemas() == null || eventClassFamily.getSchemas().size() < version) {
    int start=eventClassFamily.getSchemas() == null ? 0 : eventClassFamily.getSchemas().size();
    for (int i=start; i < version; i++) {
      String schema=getResourceAsString(TEST_EVENT_CLASS_FAMILY_SCHEMA);
      client.addEventClassFamilySchema(eventClassFamily.getId(),schema,null);
    }
  }
  applicationEventFamilyMap.setVersion(version);
  List<EventClassDto> eventClasses=toDtoList(client.getEventClassesByFamilyIdVersionAndType(eventClassFamily.getId(),version,toGenericDataStruct(EventClassType.EVENT)));
  List<ApplicationEventMapDto> eventMaps=new ArrayList<>(eventClasses.size());
  for (  EventClassDto eventClass : eventClasses) {
    ApplicationEventMapDto eventMap=new ApplicationEventMapDto();
    eventMap.setEventClassId(eventClass.getId());
    eventMap.setFqn(eventClass.getFqn());
    eventMap.setAction(ApplicationEventAction.BOTH);
    eventMaps.add(eventMap);
  }
  applicationEventFamilyMap.setEventMaps(eventMaps);
  ApplicationEventFamilyMapDto savedApplicationEventFamilyMap=toDto(client.editApplicationEventFamilyMap(toDataStruct(applicationEventFamilyMap)));
  return savedApplicationEventFamilyMap;
}

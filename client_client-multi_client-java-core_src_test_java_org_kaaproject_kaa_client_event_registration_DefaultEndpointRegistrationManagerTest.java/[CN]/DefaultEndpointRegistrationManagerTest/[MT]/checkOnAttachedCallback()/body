{
  KaaClientState state=mock(KaaClientState.class);
  when(state.getEndpointAccessToken()).thenReturn("");
  AttachEndpointToUserCallback listener=mock(AttachEndpointToUserCallback.class);
  DefaultEndpointRegistrationManager manager=new DefaultEndpointRegistrationManager(state,null,null);
  manager.setAttachedCallback(null);
  manager.onUpdate(null,null,null,new UserAttachNotification("foo","bar"),null);
  manager.setAttachedCallback(listener);
  manager.onUpdate(null,null,null,new UserAttachNotification("foo","bar"),null);
  verify(listener,times(1)).onAttachedToUser("foo","bar");
  verify(state,times(2)).setAttachedToUser(true);
  manager.setAttachedCallback(null);
  manager.attachUser("externalId","foo","bar",null);
  manager.onUpdate(null,null,new UserAttachResponse(SyncResponseResultType.SUCCESS,null,null),null,null);
  manager.setAttachedCallback(listener);
  manager.attachUser("externalId","foo","bar",null);
  manager.onUpdate(null,null,new UserAttachResponse(SyncResponseResultType.SUCCESS,null,null),null,null);
  verify(listener,times(2)).onAttachedToUser(anyString(),anyString());
  verify(state,times(4)).setAttachedToUser(true);
}

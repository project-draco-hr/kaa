{
  ChannelMetaData channel=channelMap.getById(requestMessage.getChannelId());
  if (channel == null) {
    channel=new ChannelMetaData(requestMessage);
    if (!channel.getType().isAsync() && channel.getType().isLongPoll()) {
      LOG.debug("[{}][{}] Received request using long poll channel.",endpointKey,actorKey);
      List<ChannelMetaData> channels=channelMap.getByTransportType(TransportType.EVENT);
      for (      ChannelMetaData oldChannel : channels) {
        if (!oldChannel.getType().isAsync() && channel.getType().isLongPoll()) {
          LOG.debug("[{}][{}] Closing old long poll channel [{}]",endpointKey,actorKey,oldChannel.getId());
          sendReply(context,oldChannel.getRequest(),oldChannel.getResponse().getResponse());
          channelMap.removeChannel(oldChannel);
        }
      }
    }
    channelMap.addChannel(channel);
  }
 else {
    if (channel.getType().isAsync()) {
      LOG.debug("[{}][{}] Updating request for async channel {}",endpointKey,actorKey,channel);
      channel.updateRequest(requestMessage);
    }
  }
  return channel;
}

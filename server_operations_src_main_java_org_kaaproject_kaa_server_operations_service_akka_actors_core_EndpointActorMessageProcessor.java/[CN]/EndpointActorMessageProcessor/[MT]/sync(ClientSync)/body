{
  if (!request.isValid()) {
    LOG.warn("[{}] Request is not valid. It does not contain profile information!",endpointKey);
    return SyncContext.failure(request.getRequestId());
  }
  SyncContext context=new SyncContext(new ServerSync());
  context.setEndpointProfile(state.getProfile());
  context.setRequestId(request.getRequestId());
  context.setStatus(SyncStatus.SUCCESS);
  context.setEndpointKey(endpointKey);
  context.setRequestHash(request.hashCode());
  LOG.trace("[{}][{}] processing sync. Request: {}",endpointKey,context.getRequestHash(),request);
  context=operationsService.syncProfile(context,request.getProfileSync());
  state.setProfile(context.getEndpointProfile());
  if (context.getStatus() != SyncStatus.SUCCESS) {
    return context;
  }
  context=operationsService.processEndpointAttachDetachRequests(context,request.getUserSync());
  context=operationsService.processEventListenerRequests(context,request.getEventSync());
  context.setUserConfigurationChanged(state.isUserConfigurationUpdatePending());
  context=operationsService.syncConfiguration(context,request.getConfigurationSync());
  context=operationsService.syncNotification(context,request.getNotificationSync());
  state.setProfile(operationsService.updateProfile(context));
  if (context.getStatus() == SyncStatus.SUCCESS) {
    context.setUserConfigurationChanged(false);
  }
  LOG.debug("[{}][{}] processing sync. Response is {}",endpointKey,request.hashCode(),context.getResponse());
  return context;
}

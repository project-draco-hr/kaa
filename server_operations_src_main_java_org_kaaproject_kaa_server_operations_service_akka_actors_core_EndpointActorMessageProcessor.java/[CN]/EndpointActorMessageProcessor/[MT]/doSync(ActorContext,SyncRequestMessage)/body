{
  try {
    lastActivityTime=System.currentTimeMillis();
    long start=lastActivityTime;
    SyncRequest request=requestMessage.getRequest();
    ChannelType channelType=requestMessage.getChannelType();
    LOG.debug("[{}][{}] Processing sync request {} from channel [{}]",endpointKey,actorKey,request,requestMessage.getChannelId());
    ChannelMetaData channel=fetchChannelMetaData(context,requestMessage);
    SyncResponseHolder responseHolder=operationsService.sync(request);
    EndpointProfileDto endpointProfile=responseHolder.getEndpointProfile();
    if (endpointProfile != null) {
      LogSyncResponse logUploadResponse=sendLogs(context,endpointProfile,request.getLogSyncRequest());
      if (logUploadResponse != null) {
        responseHolder.getResponse().setLogSyncResponse(logUploadResponse);
      }
      if (isValidForEvents(endpointProfile)) {
        if (userId != null && userId != endpointProfile.getEndpointUserId()) {
          LOG.debug("[{}][{}] Detected user change from [{}] to [{}]",endpointKey,actorKey,userId,endpointProfile.getEndpointUserId());
          EndpointUserDisconnectMessage userDisconnectMessage=new EndpointUserDisconnectMessage(userId,key,appToken,context.self());
          context.parent().tell(userDisconnectMessage,context.self());
          userRegistrationRequestSent=false;
        }
        if (!userRegistrationRequestSent) {
          userId=endpointProfile.getEndpointUserId();
          List<EventClassFamilyVersion> ecfVersions=convertToECFVersions(endpointProfile.getEcfVersionStates());
          EndpointUserConnectMessage userRegistrationMessage=new EndpointUserConnectMessage(userId,key,ecfVersions,appToken,context.self());
          LOG.debug("[{}][{}] Sending user registration request {}",endpointKey,actorKey,userRegistrationMessage);
          context.parent().tell(userRegistrationMessage,context.self());
          userRegistrationRequestSent=true;
        }
 else {
          LOG.trace("[{}][{}] User registration request is already sent.",endpointKey,actorKey);
        }
        sendEventsIfPresent(context,request.getEventSyncRequest());
      }
 else {
        LOG.debug("[{}][{}] Endpoint profile is not valid for send/receive events. Either no assigned user or no event families in sdk",endpointKey,actorKey);
      }
      processUserAttachDetachResults(context,request,responseHolder);
    }
 else {
      LOG.debug("[{}][{}] Endpoint profile is not set after request processing!",endpointKey,actorKey);
    }
    this.syncTime+=System.currentTimeMillis() - start;
    LOG.debug("[{}][{}] SyncResponseHolder {}",endpointKey,actorKey,responseHolder);
    if (channelType.isAsync()) {
      LOG.debug("[{}][{}] Adding async request from channel [{}] to map ",endpointKey,actorKey,requestMessage.getChannelId());
      channel.updateResponse(responseHolder);
      subscribeToTopics(context,responseHolder);
      sendReply(context,requestMessage,responseHolder.getResponse());
    }
 else {
      if (channelType.isLongPoll() && !responseHolder.requireImmediateReply()) {
        LOG.debug("[{}][{}] Adding long poll request from channel [{}] to map ",endpointKey,actorKey,requestMessage.getChannelId());
        channel.updateResponse(responseHolder);
        subscribeToTopics(context,responseHolder);
        long delay=requestMessage.getRequest().getSyncRequestMetaData().getTimeout() - (System.currentTimeMillis() - start);
        scheduleTimeoutMessage(context,requestMessage.getUuid(),delay);
      }
 else {
        sendReply(context,requestMessage,responseHolder.getResponse());
        channelMap.removeChannel(channel);
      }
    }
  }
 catch (  GetDeltaException e) {
    LOG.error("[{}][{}] processEndpointRequest",endpointKey,actorKey,e);
    sendReply(context,requestMessage,e);
  }
}

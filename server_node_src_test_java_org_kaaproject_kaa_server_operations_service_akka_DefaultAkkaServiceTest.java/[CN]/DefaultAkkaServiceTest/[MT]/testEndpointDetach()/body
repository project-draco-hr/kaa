{
  ChannelContext channelContextMock=Mockito.mock(ChannelContext.class);
  MessageEncoderDecoder targetCrypt=new MessageEncoderDecoder(targetPair.getPrivate(),targetPair.getPublic(),serverPair.getPublic());
  EndpointProfileDto targetProfileMock=Mockito.mock(EndpointProfileDto.class);
  EventClassFamilyVersionStateDto ecfVdto=new EventClassFamilyVersionStateDto();
  ecfVdto.setEcfId(ECF1_ID);
  ecfVdto.setVersion(ECF1_VERSION);
  SyncRequest targetRequest=new SyncRequest();
  targetRequest.setRequestId(REQUEST_ID);
  targetRequest.setSyncRequestMetaData(buildSyncRequestMetaData(targetPublicKeyHash));
  targetRequest.setEventSyncRequest(new EventSyncRequest());
  ServerSync targetResponse=new ServerSync();
  targetResponse.setRequestId(REQUEST_ID);
  targetResponse.setStatus(org.kaaproject.kaa.server.sync.SyncStatus.SUCCESS);
  targetResponse.setUserSync(new UserServerSync());
  SyncContext targetResponseHolder=new SyncContext(targetResponse);
  targetResponseHolder.setEndpointProfile(targetProfileMock);
  whenSync(AvroEncDec.convert(targetRequest),targetResponseHolder);
  when(targetProfileMock.getEndpointUserId()).thenReturn(USER_ID);
  when(targetProfileMock.getEndpointKeyHash()).thenReturn(targetPublicKeyHash.array());
  when(targetProfileMock.getEcfVersionStates()).thenReturn(Arrays.asList(ecfVdto));
  when(cacheService.getEventClassFamilyIdByEventClassFqn(new EventClassFqnKey(TENANT_ID,FQN1))).thenReturn(ECF1_ID);
  RouteTableKey routeKey=new RouteTableKey(APP_TOKEN,new EventClassFamilyVersion(ECF1_ID,ECF1_VERSION));
  when(cacheService.getRouteKeys(new EventClassFqnVersion(TENANT_ID,FQN1,ECF1_VERSION))).thenReturn(Collections.singleton(routeKey));
  Assert.assertNotNull(akkaService.getActorSystem());
  MessageBuilder targetResponseBuilder=Mockito.mock(MessageBuilder.class);
  ErrorBuilder targetErrorBuilder=Mockito.mock(ErrorBuilder.class);
  SessionInitMessage targetMessage=toSignedRequest(UUID.randomUUID(),ChannelType.SYNC_WITH_TIMEOUT,channelContextMock,targetRequest,targetResponseBuilder,targetErrorBuilder,targetCrypt);
  akkaService.process(targetMessage);
  Mockito.verify(operationsService,Mockito.timeout(TIMEOUT).atLeastOnce()).syncClientProfile(Mockito.any(SyncContext.class),Mockito.any(ProfileClientSync.class));
  Mockito.verify(eventService,Mockito.timeout(TIMEOUT).atLeastOnce()).sendUserRouteInfo(new UserRouteInfo(TENANT_ID,USER_ID));
  EndpointProfileDto sourceProfileMock=Mockito.mock(EndpointProfileDto.class);
  SyncRequest sourceRequest=new SyncRequest();
  sourceRequest.setRequestId(REQUEST_ID);
  sourceRequest.setSyncRequestMetaData(buildSyncRequestMetaData(clientPublicKeyHash));
  sourceRequest.setEventSyncRequest(new EventSyncRequest());
  UserSyncRequest userSyncRequest=new UserSyncRequest();
  EndpointDetachRequest eaRequest=new EndpointDetachRequest(REQUEST_ID,Base64Util.encode(targetPublicKeyHash.array()));
  userSyncRequest.setEndpointDetachRequests(Collections.singletonList(eaRequest));
  sourceRequest.setUserSyncRequest(userSyncRequest);
  ServerSync sourceResponse=new ServerSync();
  sourceResponse.setRequestId(REQUEST_ID);
  sourceResponse.setStatus(org.kaaproject.kaa.server.sync.SyncStatus.SUCCESS);
  UserServerSync userSyncResponse=new UserServerSync();
  userSyncResponse.setEndpointDetachResponses(Collections.singletonList(new org.kaaproject.kaa.server.sync.EndpointDetachResponse(REQUEST_ID,org.kaaproject.kaa.server.sync.SyncStatus.SUCCESS)));
  sourceResponse.setUserSync(userSyncResponse);
  SyncContext sourceResponseHolder=new SyncContext(sourceResponse);
  sourceResponseHolder.setEndpointProfile(sourceProfileMock);
  whenSync(AvroEncDec.convert(sourceRequest),sourceResponseHolder);
  when(sourceProfileMock.getEndpointUserId()).thenReturn(USER_ID);
  when(sourceProfileMock.getEndpointKeyHash()).thenReturn(clientPublicKeyHash.array());
  when(sourceProfileMock.getEcfVersionStates()).thenReturn(Arrays.asList(ecfVdto));
  MessageBuilder sourceResponseBuilder=Mockito.mock(MessageBuilder.class);
  ErrorBuilder sourceErrorBuilder=Mockito.mock(ErrorBuilder.class);
  SessionInitMessage sourceMessage=toSignedRequest(UUID.randomUUID(),ChannelType.SYNC_WITH_TIMEOUT,channelContextMock,sourceRequest,sourceResponseBuilder,sourceErrorBuilder);
  akkaService.process(sourceMessage);
  Mockito.verify(operationsService,Mockito.timeout(TIMEOUT).atLeastOnce()).syncClientProfile(Mockito.any(SyncContext.class),Mockito.any(ProfileClientSync.class));
  SyncResponse targetSyncResponse=new SyncResponse();
  targetSyncResponse.setRequestId(REQUEST_ID);
  targetSyncResponse.setStatus(SyncResponseResultType.SUCCESS);
  targetSyncResponse.setUserSyncResponse(new UserSyncResponse());
  targetSyncResponse.getUserSyncResponse().setUserDetachNotification(new UserDetachNotification(Base64Util.encode(clientPublicKeyHash.array())));
  AvroByteArrayConverter<SyncResponse> responseConverter=new AvroByteArrayConverter<>(SyncResponse.class);
  byte[] response=responseConverter.toByteArray(targetSyncResponse);
  byte[] encodedData=targetCrypt.encodeData(response);
  Mockito.verify(targetResponseBuilder,Mockito.timeout(TIMEOUT).atLeastOnce()).build(encodedData,true);
}

{
  akkaService=new DefaultAkkaService();
  AkkaContext context=new AkkaContext();
  clusterService=mock(ClusterService.class);
  cacheService=mock(CacheService.class);
  metricsService=mock(MetricsService.class);
  operationsKeyStoreService=mock(KeyStoreService.class);
  operationsService=mock(OperationsService.class);
  notificationDeltaService=mock(NotificationDeltaService.class);
  applicationService=mock(ApplicationService.class);
  eventService=mock(EventService.class);
  logAppenderService=mock(LogAppenderService.class);
  endpointUserService=mock(EndpointUserService.class);
  ctlService=mock(CTLService.class);
  credentialsServiceLocator=mock(CredentialsServiceLocator.class);
  credentialsService=mock(CredentialsService.class);
  registrationService=mock(RegistrationService.class);
  ReflectionTestUtils.setField(context,"clusterService",clusterService);
  ReflectionTestUtils.setField(context,"cacheService",cacheService);
  ReflectionTestUtils.setField(context,"metricsService",metricsService);
  ReflectionTestUtils.setField(context,"operationsKeyStoreService",operationsKeyStoreService);
  ReflectionTestUtils.setField(context,"operationsService",operationsService);
  ReflectionTestUtils.setField(context,"notificationDeltaService",notificationDeltaService);
  ReflectionTestUtils.setField(context,"applicationService",applicationService);
  ReflectionTestUtils.setField(context,"eventService",eventService);
  ReflectionTestUtils.setField(context,"logAppenderService",logAppenderService);
  ReflectionTestUtils.setField(context,"endpointUserService",endpointUserService);
  ReflectionTestUtils.setField(context,"ctlService",ctlService);
  ReflectionTestUtils.setField(context,"credentialsServiceLocator",credentialsServiceLocator);
  ReflectionTestUtils.setField(context,"registrationService",registrationService);
  clientPair=KeyUtil.generateKeyPair();
  targetPair=KeyUtil.generateKeyPair();
  serverPair=KeyUtil.generateKeyPair();
  Mockito.when(operationsKeyStoreService.getPublicKey()).thenReturn(serverPair.getPublic());
  Mockito.when(operationsKeyStoreService.getPrivateKey()).thenReturn(serverPair.getPrivate());
  Mockito.when(metricsService.createMeter(Mockito.anyString(),Mockito.anyString())).thenReturn(Mockito.mock(MeterClient.class));
  Mockito.when(credentialsServiceLocator.getCredentialsService(Mockito.anyString())).thenReturn(credentialsService);
  Mockito.when(credentialsService.lookupCredentials(Mockito.anyString())).thenReturn(Optional.ofNullable((CredentialsDto)null));
  registerPublicKey(clientPair.getPublic());
  registerPublicKey(targetPair.getPublic());
  ReflectionTestUtils.setField(akkaService,"context",context);
  if (akkaService.getActorSystem() == null) {
    akkaService.initActorSystem();
  }
  clusterServiceListener=(AkkaClusterServiceListener)ReflectionTestUtils.getField(akkaService,"clusterListener");
  clientPublicKey=ByteBuffer.wrap(clientPair.getPublic().getEncoded());
  clientPublicKeyHash=ByteBuffer.wrap(SHA1HashUtils.hashToBytes(clientPair.getPublic().getEncoded()));
  targetPublicKeyHash=ByteBuffer.wrap(SHA1HashUtils.hashToBytes(targetPair.getPublic().getEncoded()));
  Mockito.when(cacheService.getTenantIdByAppToken(APP_TOKEN)).thenReturn(TENANT_ID);
  Mockito.when(cacheService.getAppTokenBySdkToken(SDK_TOKEN)).thenReturn(APP_TOKEN);
  Mockito.when(cacheService.getAppTokenBySdkToken(INVALID_SDK_TOKEN)).thenReturn(null);
  Mockito.when(cacheService.getEndpointKey(EndpointObjectHash.fromBytes(clientPublicKeyHash.array()))).thenReturn(clientPair.getPublic());
  Mockito.when(cacheService.getEndpointKey(EndpointObjectHash.fromBytes(targetPublicKeyHash.array()))).thenReturn(targetPair.getPublic());
  applicationDto=new ApplicationDto();
  applicationDto.setId(APP_ID);
  applicationDto.setApplicationToken(APP_TOKEN);
  applicationDto.setTenantId(TENANT_ID);
  ServerSync response=new ServerSync();
  response.setRequestId(REQUEST_ID);
  response.setStatus(org.kaaproject.kaa.server.sync.SyncStatus.SUCCESS);
  ConfigurationServerSync confSyncResponse=new ConfigurationServerSync();
  confSyncResponse.setResponseStatus(org.kaaproject.kaa.server.sync.SyncResponseStatus.NO_DELTA);
  response.setConfigurationSync(confSyncResponse);
  noDeltaResponse=new SyncContext(response);
  Map<String,Integer> subscriptionStates=new HashMap<>();
  subscriptionStates.put(TOPIC_ID,new Integer(0));
  noDeltaResponseWithTopicState=new SyncContext(response);
  noDeltaResponseWithTopicState.setSubscriptionStates(subscriptionStates);
  EndpointProfileDto epDto=new EndpointProfileDto();
  epDto.setSystemNfVersion(42);
  epDto.setUserNfVersion(43);
  epDto.setLogSchemaVersion(44);
  noDeltaResponseWithTopicState.setEndpointProfile(epDto);
  response=new ServerSync();
  response.setStatus(org.kaaproject.kaa.server.sync.SyncStatus.SUCCESS);
  confSyncResponse=new ConfigurationServerSync();
  confSyncResponse.setResponseStatus(org.kaaproject.kaa.server.sync.SyncResponseStatus.DELTA);
  response.setConfigurationSync(confSyncResponse);
  deltaResponse=new SyncContext(response);
  response=new ServerSync();
  response.setStatus(org.kaaproject.kaa.server.sync.SyncStatus.SUCCESS);
  confSyncResponse=new ConfigurationServerSync();
  confSyncResponse.setResponseStatus(org.kaaproject.kaa.server.sync.SyncResponseStatus.DELTA);
  response.setConfigurationSync(confSyncResponse);
  deltaResponseWithProfile=new SyncContext(response);
  mockProfile=mock(EndpointProfileDto.class);
  deltaResponseWithProfile.setEndpointProfile(mockProfile);
  response=new ServerSync();
  response.setRequestId(REQUEST_ID);
  response.setStatus(org.kaaproject.kaa.server.sync.SyncStatus.SUCCESS);
  simpleResponse=new SyncContext(response);
  topicNotification=new NotificationDto();
  topicNotification.setApplicationId(APP_ID);
  topicNotification.setTopicId(TOPIC_ID);
  topicNotification.setId(UNICAST_NOTIFICATION_ID);
  topicNotification.setExpiredAt(new Date(System.currentTimeMillis() + TimeUnit.DAYS.toMillis(7)));
  topicNotification.setSecNum(1);
  topicNotification.setNfVersion(42);
  topicNotification.setType(NotificationTypeDto.SYSTEM);
  topicNotification.setBody("I am a dummy notification".getBytes());
  when(applicationService.findAppByApplicationToken(APP_TOKEN)).thenReturn(applicationDto);
  when(applicationService.findAppById(APP_ID)).thenReturn(applicationDto);
  when(endpointUserService.findUserVerifiers(APP_ID)).thenReturn(new ArrayList<UserVerifierDto>());
  when(eventService.isMainUserNode(Mockito.anyString())).thenReturn(true);
  when(clusterService.getNodeId()).thenReturn(LOCAL_NODE_ID);
  when(clusterService.getEntityNode(Mockito.any(byte[].class))).thenReturn(LOCAL_NODE_ID);
  when(clusterService.getEntityNode(Mockito.any(EndpointObjectHash.class))).thenReturn(LOCAL_NODE_ID);
}

{
  ClientSyncMetaData metaData=request.getSyncRequestMetaData();
  String endpointId=Base64Util.encode(metaData.getEndpointPublicKeyHash().array());
  int requestHash=request.hashCode();
  LOG.trace("[{}][{}] processing sync. request: {}",endpointId,requestHash,request);
  if (!validate(endpointId,request)) {
    return SyncResponseHolder.failure(request.getRequestId());
  }
  SyncResponseHolder response=new SyncResponseHolder(new ServerSync());
  response.setRequestId(request.getRequestId());
  response.setStatus(SyncResponseResultType.SUCCESS);
  ProfileClientSync profileSyncRequest=request.getProfileSyncRequest();
  if (profileSyncRequest != null) {
    ProfileServerSync profileSyncResponse;
    if (profileSyncRequest.getEndpointPublicKey() != null) {
      LOG.debug("[{}][{}] registration of endpoint started.",endpointId,requestHash);
      profile=registerEndpoint(endpointId,requestHash,metaData,profileSyncRequest);
    }
 else {
      LOG.debug("[{}][{}] update of endpoint profile started.",endpointId,requestHash);
      profile=updateEndpoint(endpointId,requestHash,metaData,profileSyncRequest);
    }
    profileSyncResponse=new ProfileServerSync(SyncResponseStatus.DELTA);
    metaData.setProfileHash(ByteBuffer.wrap(profile.getProfileHash()));
    response.setProfileSyncResponse(profileSyncResponse);
  }
  AppSeqNumber appSeqNumber=cacheService.getAppSeqNumber(metaData.getApplicationToken());
  int curAppSeqNumber=appSeqNumber.getSeqNumber();
  LOG.debug("[{}][{}] fetched app seq number {}",endpointId,requestHash,curAppSeqNumber);
  if (profile == null) {
    LOG.debug("[{}][{}] fetching profile.",endpointId,requestHash);
    EndpointObjectHash endpointHash=EndpointObjectHash.fromBytes(metaData.getEndpointPublicKeyHash().array());
    profile=profileService.getProfile(endpointHash);
    LOG.trace("[{}][{}] fetched profile {}.",endpointId,requestHash,profile);
  }
  response.setEndpointProfile(profile);
  if (!Arrays.equals(profile.getProfileHash(),toByteArray(metaData.getProfileHash()))) {
    LOG.debug("[{}] Profile hash mismatch. Profile resync needed");
    return buildProfileResyncResponse(request);
  }
  if (request.getUserSyncRequest() != null) {
    LOG.trace("[{}][{}] procesing user sync request {}.",endpointId,requestHash,request.getUserSyncRequest());
    UserServerSync userSyncResponse=processUserSyncRequest(endpointId,requestHash,metaData,request.getUserSyncRequest(),profile);
    response.setUserSyncResponse(userSyncResponse);
  }
  if (request.getEventSyncRequest() != null) {
    LOG.trace("[{}][{}] procesing event sync request {}.",endpointId,requestHash,request.getEventSyncRequest());
    EventServerSync eventSyncResponse=processEventSyncResponse(endpointId,requestHash,appSeqNumber,request.getEventSyncRequest(),profile);
    response.setEventSyncResponse(eventSyncResponse);
  }
  boolean updateProfileRequired=false;
  if (request.getConfigurationSyncRequest() != null) {
    ConfigurationClientSync confSyncRequest=request.getConfigurationSyncRequest();
    LOG.trace("[{}][{}] procesing configuration sync request {}.",endpointId,requestHash,confSyncRequest);
    LOG.debug("[{}][{}] fetching history for seq numbers {}-{}",endpointId,requestHash,confSyncRequest.getAppStateSeqNumber(),curAppSeqNumber);
    int startSeqNumber=Math.min(confSyncRequest.getAppStateSeqNumber(),profile.getCfSequenceNumber());
    LOG.debug("[{}][{}] calculating configuration delta using seq number {}",endpointId,requestHash,startSeqNumber);
    confSyncRequest.setAppStateSeqNumber(startSeqNumber);
    HistoryDelta historyDelta=fetchHistory(endpointId,requestHash,metaData.getApplicationToken(),profile,HistorySubject.CONFIGURATION,startSeqNumber,curAppSeqNumber);
    GetDeltaResponse confResponse=calculateConfigurationDelta(metaData,confSyncRequest,profile,historyDelta,curAppSeqNumber);
    ConfigurationServerSync confSyncResponse=buildConfSyncResponse(confResponse,curAppSeqNumber);
    response.setConfigurationSyncResponse(confSyncResponse);
    if (historyDelta.isSmthChanged()) {
      List<EndpointGroupStateDto> endpointGroups=historyDelta.getEndpointGroupStates();
      LOG.debug("[{}][{}] Updating profile with endpoint groups.size {}, groups: {}",endpointId,requestHash,endpointGroups.size(),endpointGroups);
      profile.setCfGroupStates(endpointGroups);
      profile.setCfSequenceNumber(curAppSeqNumber);
      updateProfileRequired=true;
    }
  }
  if (request.getNotificationSyncRequest() != null) {
    NotificationClientSync nfSyncRequest=request.getNotificationSyncRequest();
    LOG.trace("[{}][{}] procesing notification sync request {}.",endpointId,requestHash,nfSyncRequest);
    LOG.debug("[{}][{}] fetching history for seq numbers {}-{}",endpointId,requestHash,nfSyncRequest.getAppStateSeqNumber(),curAppSeqNumber);
    int startSeqNumber=Math.min(nfSyncRequest.getAppStateSeqNumber(),profile.getNfSequenceNumber());
    LOG.debug("[{}][{}] calculating notification delta using seq number {}",endpointId,requestHash,startSeqNumber);
    HistoryDelta historyDelta=fetchHistory(endpointId,requestHash,metaData.getApplicationToken(),profile,HistorySubject.NOTIFICATION,startSeqNumber,curAppSeqNumber);
    GetNotificationResponse notificationResponse=calculateNotificationDelta(nfSyncRequest,profile,historyDelta);
    response.setSubscriptionStates(notificationResponse.getSubscriptionStates());
    NotificationServerSync nfSyncResponse=buildNotificationSyncResponse(notificationResponse,curAppSeqNumber);
    response.setNotificationSyncResponse(nfSyncResponse);
    updateProfileRequired=updateProfileRequired || notificationResponse.isSubscriptionListChanged();
    if (historyDelta.isSmthChanged()) {
      List<EndpointGroupStateDto> endpointGroups=historyDelta.getEndpointGroupStates();
      LOG.debug("[{}][{}] Updating profile with endpoint groups.size {}, groups: {}",endpointId,requestHash,endpointGroups.size(),endpointGroups);
      profile.setNfGroupStates(endpointGroups);
      profile.setNfSequenceNumber(curAppSeqNumber);
      updateProfileRequired=true;
    }
  }
  LOG.debug("[{}][{}] response is {}",endpointId,request.hashCode(),response);
  if (!operationServerHash.equals(profile.getServerHash())) {
    LOG.debug("[{}] Operations server hash changed from {} to {}",endpointId,profile.getServerHash(),operationServerHash);
    profile.setServerHash(operationServerHash);
    updateProfileRequired=true;
  }
  if (updateProfileRequired) {
    response.setEndpointProfile(profileService.updateProfile(profile));
  }
  LOG.debug("[{}][{}] processed sync request",endpointId,requestHash);
  return response;
}

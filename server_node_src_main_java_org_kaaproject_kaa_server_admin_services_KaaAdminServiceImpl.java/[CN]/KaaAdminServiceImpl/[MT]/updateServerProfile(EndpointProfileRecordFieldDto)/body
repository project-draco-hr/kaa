{
  checkAuthority(KaaAuthorityDto.TENANT_DEVELOPER,KaaAuthorityDto.TENANT_USER);
  try {
    String keyHash=Base64Util.encode(endpointProfileRecordDto.getEndpointKeyHash());
    EndpointProfileDto profileDto=controlService.getEndpointProfileByKeyHash(keyHash);
    checkApplicationId(profileDto.getApplicationId());
    RecordField profileRecord=endpointProfileRecordDto.getProfileRecord();
    String ctlSchemaId=endpointProfileRecordDto.getCtlSchemaId();
    if (ctlSchemaId != null && profileRecord != null) {
      GenericRecord record=FormAvroConverter.createGenericRecordFromRecordField(profileRecord);
      GenericAvroConverter<GenericRecord> converter=new GenericAvroConverter<GenericRecord>(record.getSchema());
      profileDto.setServerProfileCtlSchemaId(ctlSchemaId);
      profileDto.setServerProfileBody(converter.encodeToJson(record));
      profileDto=controlService.updateEndpointProfile(profileDto);
    }
    endpointProfileRecordDto.setCtlSchemaId(profileDto.getServerProfileCtlSchemaId());
    endpointProfileRecordDto.setEndpointKeyHash(profileDto.getEndpointKeyHash());
    return endpointProfileRecordDto;
  }
 catch (  Exception e) {
    throw Utils.handleException(e);
  }
}

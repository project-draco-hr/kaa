{
  LOG.debug("Registering Profile for {}",request.getEndpointKey());
  LOG.trace("Lookup application by token: {}",request.getAppToken());
  AppSeqNumber appSeqNumber=cacheService.getAppSeqNumber(request.getAppToken());
  LOG.trace("Application by token: {} found: {}",request.getAppToken(),appSeqNumber);
  String profileJson=decodeProfile(request.getProfile(),appSeqNumber.getAppToken(),request.getVersionInfo().getProfileVersion());
  EndpointProfileDto dto=new EndpointProfileDto();
  dto.setApplicationId(appSeqNumber.getAppId());
  dto.setEndpointKey(request.getEndpointKey());
  dto.setEndpointKeyHash(EndpointObjectHash.fromSHA1(request.getEndpointKey()).getData());
  dto.setProfile(profileJson);
  dto.setProfileHash(EndpointObjectHash.fromSHA1(request.getProfile()).getData());
  populateVersionStates(appSeqNumber.getTenantId(),dto,request.getVersionInfo());
  if (request.getAccessToken() != null) {
    dto.setAccessToken(request.getAccessToken());
  }
  dto.setCfSequenceNumber(0);
  dto.setNfSequenceNumber(0);
  dto.setChangedFlag(Boolean.FALSE);
  return endpointService.saveEndpointProfile(dto);
}

{
  LOG.debug("Registering Profile for {}",request.getEndpointKey());
  LOG.trace("Lookup application by token: {}",request.getAppToken());
  AppSeqNumber appSeqNumber=cacheService.getAppSeqNumber(request.getAppToken());
  LOG.trace("Application by token: {} found: {}",request.getAppToken(),appSeqNumber);
  SdkPropertiesDto sdkProperties=cacheService.getSdkPropertiesBySdkToken(request.getSdkToken());
  LOG.trace("Sdk properties by sdk token: {} found: {}",request.getSdkToken(),sdkProperties);
  String profileJson=decodeProfile(request.getProfile(),appSeqNumber.getAppToken(),sdkProperties.getProfileSchemaVersion());
  EndpointObjectHash keyHash=EndpointObjectHash.fromSHA1(request.getEndpointKey());
  EndpointProfileDto dto=endpointService.findEndpointProfileByKeyHash(keyHash.getData());
  if (dto == null) {
    dto=new EndpointProfileDto();
    dto.setApplicationId(appSeqNumber.getAppId());
    dto.setEndpointKey(request.getEndpointKey());
    dto.setEndpointKeyHash(keyHash.getData());
    dto.setProfile(profileJson);
    dto.setProfileHash(EndpointObjectHash.fromSHA1(request.getProfile()).getData());
    populateVersionStates(appSeqNumber.getTenantId(),dto,sdkProperties);
    if (request.getAccessToken() != null) {
      dto.setAccessToken(request.getAccessToken());
    }
    dto.setCfSequenceNumber(0);
    dto.setNfSequenceNumber(0);
    dto.setChangedFlag(Boolean.FALSE);
    return endpointService.saveEndpointProfile(dto);
  }
 else {
    return updateProfile(new UpdateProfileRequest(request.getAppToken(),keyHash,request.getAccessToken(),request.getProfile(),request.getSdkToken()));
  }
}

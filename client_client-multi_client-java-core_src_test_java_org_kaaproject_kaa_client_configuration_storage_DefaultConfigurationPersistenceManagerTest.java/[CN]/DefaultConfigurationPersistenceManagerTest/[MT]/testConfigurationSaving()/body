{
  URL schemaUrl=Thread.currentThread().getContextClassLoader().getResource("configuration/manager/complexFieldsDeltaSchema.json");
  final Schema complexSchema=new Schema.Parser().parse(new File(schemaUrl.getPath()));
  ConfigurationProcessor processor=mock(ConfigurationProcessor.class);
  DefaultConfigurationManager configManager=new DefaultConfigurationManager();
  DefaultConfigurationPersistenceManager persistenceManager=new DefaultConfigurationPersistenceManager(complexSchema,processor);
  final GenericRecord complexDelta=new GenericData.Record(DefaultConfigurationManagerTest.getDeltaSchemaByFullName(complexSchema,"org.kaa.config.testT"));
  DefaultConfigurationManagerTest.fillComplexFullResyncDelta(complexDelta);
  configManager.onDeltaReceived(0,complexDelta,true);
  persistenceManager.setConfigurationStorage(new ConfigurationStorage(){
    @Override public void saveConfiguration(    ByteBuffer buffer){
      assertArrayEquals(serializeDelta(complexDelta,complexSchema),buffer.array());
    }
    @Override public ByteBuffer loadConfiguration(){
      return null;
    }
  }
);
  CommonRecord rootRecord=configManager.getConfiguration();
  persistenceManager.onConfigurationUpdated(rootRecord);
  schemaUrl=Thread.currentThread().getContextClassLoader().getResource("configuration/manager/arrayFieldsDeltaSchema.json");
  final Schema arraySchema=new Schema.Parser().parse(new File(schemaUrl.getPath()));
  persistenceManager.onSchemaUpdated(arraySchema);
  final GenericRecord arrayDelta=new GenericData.Record(DefaultConfigurationManagerTest.getDeltaSchemaByFullName(arraySchema,"org.kaa.config.testT"));
  DefaultConfigurationManagerTest.fillArrayFullResyncDelta(arrayDelta);
  configManager=new DefaultConfigurationManager();
  configManager.onDeltaReceived(0,arrayDelta,true);
  rootRecord=configManager.getConfiguration();
  persistenceManager.setConfigurationStorage(new ConfigurationStorage(){
    @Override public void saveConfiguration(    ByteBuffer buffer){
      assertArrayEquals(serializeDelta(arrayDelta,arraySchema),buffer.array());
    }
    @Override public ByteBuffer loadConfiguration(){
      return null;
    }
  }
);
  persistenceManager.onConfigurationUpdated(rootRecord);
}

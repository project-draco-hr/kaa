{
  Timing timing=new Timing();
  TestingCluster cluster=new TestingCluster(3);
  cluster.start();
  try {
    ControlNodeInfo controlNodeInfo=buildControlNodeInfo();
    ControlNodeInfo secondaryNodeInfo=buildSecondaryNodeInfo();
    OperationsNodeInfo endpointNodeInfo=buildOperationsNodeInfo();
    OperationsNode endpointNode=new OperationsNode(endpointNodeInfo,cluster.getConnectString(),buildDefaultRetryPolicy());
    endpointNode.start();
    assertNull(endpointNode.getControlServerInfo());
    ControlNode controlNode=new ControlNode(controlNodeInfo,cluster.getConnectString(),buildDefaultRetryPolicy());
    assertFalse(controlNode.isMaster());
    controlNode.start();
    ControlNode secondaryNode=new ControlNode(secondaryNodeInfo,cluster.getConnectString(),buildDefaultRetryPolicy());
    assertFalse(secondaryNode.isMaster());
    secondaryNode.start();
    timing.sleepABit();
    assertTrue(controlNode.isMaster());
    assertFalse(secondaryNode.isMaster());
    assertNotNull(endpointNode.getControlServerInfo());
    assertEquals(CONTROL_NODE_HOST,endpointNode.getControlServerInfo().getConnectionInfo().getThriftHost().toString());
    controlNode.close();
    timing.sleepABit();
    assertNotNull(endpointNode.getControlServerInfo());
    assertEquals(SECONDARY_NODE_HOST,endpointNode.getControlServerInfo().getConnectionInfo().getThriftHost().toString());
    secondaryNode.close();
    endpointNode.close();
  }
  finally {
    cluster.close();
  }
}

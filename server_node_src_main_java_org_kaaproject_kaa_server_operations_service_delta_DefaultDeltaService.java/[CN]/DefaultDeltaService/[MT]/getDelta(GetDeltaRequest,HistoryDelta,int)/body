{
  GetDeltaResponse response;
  EndpointProfileDto profile=request.getEndpointProfile();
  String endpointId="N/A";
  if (LOG.isDebugEnabled() && profile != null && profile.getEndpointKeyHash() != null) {
    endpointId=Base64Util.encode(profile.getEndpointKeyHash());
  }
  boolean hashMismatch=!request.isFirstRequest() && !request.getConfigurationHash().binaryEquals(profile.getConfigurationHash());
  AppVersionKey appConfigVersionKey=new AppVersionKey(request.getApplicationToken(),profile.getConfigurationVersion());
  List<EndpointGroupStateDto> endpointGroups=historyDelta.getEndpointGroupStates();
  if (isChangePossible(request,historyDelta,hashMismatch)) {
    boolean resync=request.isFirstRequest() || request.isResyncOnly();
    if (hashMismatch) {
      resync=true;
      logHashMismatch(request,profile,endpointId);
    }
    DeltaCacheKey deltaKey;
    if (resync) {
      deltaKey=new DeltaCacheKey(appConfigVersionKey,endpointGroups,EndpointObjectHash.fromBytes(request.getUserConfigurationHash()),null,request.isResyncOnly());
      LOG.debug("[{}] Building resync delta key {}",endpointId,deltaKey);
    }
 else {
      deltaKey=new DeltaCacheKey(appConfigVersionKey,endpointGroups,EndpointObjectHash.fromBytes(request.getUserConfigurationHash()),request.getConfigurationHash());
      LOG.debug("[{}] Building regular delta key {}",endpointId,deltaKey);
    }
    DeltaCacheEntry deltaCacheEntry=getDelta(endpointId,profile.getEndpointUserId(),deltaKey);
    byte[] configurationHash=deltaCacheEntry.getHash().getData();
    if (LOG.isTraceEnabled()) {
      LOG.trace("[{}] Result configuration hash is {} for delta key {}",endpointId,Arrays.toString(configurationHash),deltaKey);
    }
    if (isFirstRequestWithUpToDateConfiguration(request,profile,configurationHash)) {
      response=new GetDeltaResponse(GetDeltaResponseType.NO_DELTA,curAppSeqNumber);
    }
 else {
      if (resync) {
        if (isConfigurationUpToDate(request,configurationHash)) {
          response=new GetDeltaResponse(GetDeltaResponseType.NO_DELTA,curAppSeqNumber);
        }
 else {
          response=new GetDeltaResponse(GetDeltaResponseType.CONF_RESYNC,curAppSeqNumber,deltaCacheEntry.getDelta());
        }
      }
 else {
        if (deltaCacheEntry.getDelta().hasChanges()) {
          response=new GetDeltaResponse(GetDeltaResponseType.DELTA,curAppSeqNumber,deltaCacheEntry.getDelta());
        }
 else {
          LOG.debug("[{}] Delta has no changes -> no delta",endpointId);
          response=new GetDeltaResponse(GetDeltaResponseType.NO_DELTA,curAppSeqNumber);
        }
      }
    }
    profile.setConfigurationHash(configurationHash);
    if (deltaCacheEntry.getUserConfigurationHash() != null) {
      profile.setUserConfigurationHash(deltaCacheEntry.getUserConfigurationHash().getData());
    }
 else {
      profile.setUserConfigurationHash(null);
    }
  }
 else {
    LOG.debug("[{}] No changes to current application group configurations was maid -> no delta",endpointId);
    response=new GetDeltaResponse(GetDeltaResponseType.NO_DELTA,curAppSeqNumber);
  }
  LOG.debug("[{}] Response: {}",endpointId,response);
  return response;
}

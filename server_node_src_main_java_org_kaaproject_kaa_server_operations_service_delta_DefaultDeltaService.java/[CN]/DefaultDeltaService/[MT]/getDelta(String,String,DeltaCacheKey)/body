{
  EndpointUserConfigurationDto userConfiguration=findLatestUserConfiguration(userId,deltaKey);
  final DeltaCacheKey newKey;
  if (userConfiguration != null) {
    newKey=new DeltaCacheKey(deltaKey.getAppConfigVersionKey(),deltaKey.getEndpointGroups(),EndpointObjectHash.fromString(userConfiguration.getBody()),deltaKey.getEndpointConfHash(),deltaKey.isResyncOnly());
  }
 else {
    newKey=deltaKey;
  }
  ConfigurationCacheEntry deltaCacheEntry=cacheService.getDelta(newKey,new Computable<DeltaCacheKey,ConfigurationCacheEntry>(){
    @Override public ConfigurationCacheEntry compute(    DeltaCacheKey deltaKey){
      try {
        LOG.debug("[{}] Calculating delta for {}",endpointId,deltaKey);
        ConfigurationCacheEntry deltaCache;
        ConfigurationSchemaDto latestConfigurationSchema=cacheService.getConfSchemaByAppAndVersion(deltaKey.getAppConfigVersionKey());
        EndpointUserConfigurationDto userConfiguration=findLatestUserConfiguration(userId,deltaKey);
        EndpointObjectHash userConfigurationHash=null;
        if (userConfiguration != null) {
          userConfigurationHash=EndpointObjectHash.fromString(userConfiguration.getBody());
        }
        BaseData mergedConfiguration=getMergedConfiguration(endpointId,userConfiguration,deltaKey,latestConfigurationSchema);
        LOG.trace("[{}] Merged configuration {}",endpointId,mergedConfiguration.getRawData());
        deltaCache=buildBaseResyncDelta(endpointId,mergedConfiguration,userConfigurationHash);
        if (cacheService.getConfByHash(deltaCache.getHash()) == null) {
          EndpointConfigurationDto newConfiguration=new EndpointConfigurationDto();
          newConfiguration.setConfiguration(deltaCache.getConfiguration());
          newConfiguration.setConfigurationHash(deltaCache.getHash().getData());
          cacheService.putConfiguration(deltaCache.getHash(),newConfiguration);
        }
        LOG.debug("[{}] Configuration hash for {} is {}",endpointId,deltaKey,MessageEncoderDecoder.bytesToHex(deltaCache.getHash().getData()));
        return deltaCache;
      }
 catch (      GetDeltaException e) {
        throw new RuntimeException(e);
      }
    }
  }
);
  return deltaCacheEntry;
}

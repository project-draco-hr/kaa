{
  SdkPropertiesDto sdkPropertiesDto=ThriftDtoConverter.toDto(sdkProperties);
  try {
    ApplicationDto application=applicationService.findAppById(sdkPropertiesDto.getApplicationId());
    if (application == null) {
      throw new TException("Application not found!");
    }
    ProfileSchemaDto profileSchema=profileService.findProfileSchemaByAppIdAndVersion(sdkPropertiesDto.getApplicationId(),sdkPropertiesDto.getProfileSchemaVersion());
    if (profileSchema == null) {
      throw new TException("Profile schema not found!");
    }
    ConfigurationSchemaDto configurationSchema=configurationService.findConfSchemaByAppIdAndVersion(sdkPropertiesDto.getApplicationId(),sdkPropertiesDto.getConfigurationSchemaVersion());
    if (configurationSchema == null) {
      throw new TException("Configuration schema not found!");
    }
    ConfigurationDto defaultConfiguration=configurationService.findDefaultConfigurationBySchemaId(configurationSchema.getId());
    if (defaultConfiguration == null) {
      throw new TException("Default configuration not found!");
    }
    NotificationSchemaDto notificationSchema=notificationService.findNotificationSchemaByAppIdAndTypeAndVersion(sdkPropertiesDto.getApplicationId(),NotificationTypeDto.USER,sdkPropertiesDto.getNotificationSchemaVersion());
    if (notificationSchema == null) {
      throw new TException("Notification schema not found!");
    }
    LogSchemaDto logSchema=logSchemaService.findLogSchemaByAppIdAndVersion(sdkPropertiesDto.getApplicationId(),sdkPropertiesDto.getLogSchemaVersion());
    if (logSchema == null) {
      throw new TException("Log schema not found!");
    }
    DataSchema profileDataSchema=new DataSchema(profileSchema.getSchema());
    DataSchema notificationDataSchema=new DataSchema(notificationSchema.getSchema());
    ProtocolSchema protocolSchema=new ProtocolSchema(configurationSchema.getProtocolSchema());
    DataSchema logDataSchema=new DataSchema(logSchema.getSchema());
    String appToken=application.getApplicationToken();
    String profileSchemaBody=profileDataSchema.getRawSchema();
    byte[] defaultConfigurationData=GenericAvroConverter.toRawData(defaultConfiguration.getBody(),configurationSchema.getBaseSchema());
    List<EventFamilyMetadata> eventFamilies=new ArrayList<>();
    if (sdkPropertiesDto.getAefMapIds() != null) {
      List<ApplicationEventFamilyMapDto> aefMaps=applicationEventMapService.findApplicationEventFamilyMapsByIds(sdkPropertiesDto.getAefMapIds());
      for (      ApplicationEventFamilyMapDto aefMap : aefMaps) {
        EventFamilyMetadata efm=new EventFamilyMetadata();
        efm.setVersion(aefMap.getVersion());
        efm.setEventMaps(aefMap.getEventMaps());
        EventClassFamilyDto ecf=eventClassService.findEventClassFamilyById(aefMap.getEcfId());
        efm.setEcfName(ecf.getName());
        efm.setEcfNamespace(ecf.getNamespace());
        efm.setEcfClassName(ecf.getClassName());
        List<EventSchemaVersionDto> ecfSchemas=ecf.getSchemas();
        for (        EventSchemaVersionDto ecfSchema : ecfSchemas) {
          if (ecfSchema.getVersion() == efm.getVersion()) {
            efm.setEcfSchema(ecfSchema.getSchema());
            break;
          }
        }
        eventFamilies.add(efm);
      }
    }
    sdkPropertiesDto.setApplicationToken(appToken);
    sdkPropertiesDto=sdkKeyService.saveSdkKey(sdkPropertiesDto);
    String sdkToken=new SdkKey(sdkPropertiesDto).getToken();
    LOG.debug("Sdk properties for sdk generation: {}",sdkPropertiesDto);
    SdkGenerator generator=SdkGeneratorFactory.createSdkGenerator(sdkPropertiesDto.getTargetPlatform());
    return generator.generateSdk(Version.PROJECT_VERSION,controlZKService.getCurrentBootstrapNodes(),sdkToken,sdkPropertiesDto,profileSchemaBody,notificationDataSchema.getRawSchema(),protocolSchema.getRawSchema(),configurationSchema.getBaseSchema(),defaultConfigurationData,eventFamilies,logDataSchema.getRawSchema());
  }
 catch (  Exception e) {
    LOG.error("Unable to generate SDK",e);
    throw new TException(e);
  }
}

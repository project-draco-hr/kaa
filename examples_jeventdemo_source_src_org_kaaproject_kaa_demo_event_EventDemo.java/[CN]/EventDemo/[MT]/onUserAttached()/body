{
  List<String> listenerFQNs=new LinkedList<>();
  listenerFQNs.add(ThermostatInfoRequest.class.getName());
  listenerFQNs.add(ChangeDegreeRequest.class.getName());
  final EventFamilyFactory eventFamilyFactory=kaaClient.getEventFamilyFactory();
  final ThermostatEventClassFamily tecf=eventFamilyFactory.getThermostatEventClassFamily();
  tecf.addListener(new ThermostatEventClassFamily.Listener(){
    @Override public void onEvent(    ChangeDegreeRequest changeDegreeRequest,    String senderId){
      LOG.info("ChangeDegreeRequest event received! change temperature by {} degrees, sender: {}",changeDegreeRequest.getDegree(),senderId);
    }
    @Override public void onEvent(    ThermostatInfoResponse thermostatInfoResponse,    String senderId){
      LOG.info("ThermostatInfoResponse event received! thermostat info: {}, sender: {}",thermostatInfoResponse.getThermostatInfo(),senderId);
    }
    @Override public void onEvent(    ThermostatInfoRequest thermostatInfoRequest,    String senderId){
      LOG.info("ThermostatInfoRequest event received! sender: {}",senderId);
      tecf.sendEvent(new ThermostatInfoResponse(),senderId);
    }
  }
);
  kaaClient.findEventListeners(listenerFQNs,new FindEventListenersCallback(){
    @Override public void onEventListenersReceived(    List<String> eventListeners){
      LOG.info("{} event listeners received",eventListeners.size());
      for (      String listener : eventListeners) {
        LOG.info("listener: {}",listener);
      }
      tecf.sendEventToAll(new ChangeDegreeRequest(10));
      LOG.info("Broadcast ChangeDegreeRequest sent");
      TransactionId trxId=eventFamilyFactory.startEventsBlock();
      tecf.addEventToBlock(trxId,new ThermostatInfoRequest());
      tecf.addEventToBlock(trxId,new ChangeDegreeRequest(-30),eventListeners.get(0));
      eventFamilyFactory.submitEventsBlock(trxId);
      LOG.info("Batch of events sent: broadcast ThermostatInfoRequest & ChangeDegreeRequest to endpoint with id {}",eventListeners.get(0));
    }
    @Override public void onRequestFailed(){
      LOG.info("Request failed");
    }
  }
);
}

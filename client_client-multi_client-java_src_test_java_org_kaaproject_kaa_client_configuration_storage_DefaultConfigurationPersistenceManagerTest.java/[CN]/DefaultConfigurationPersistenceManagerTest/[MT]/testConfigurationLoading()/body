{
  URL schemaUrl=Thread.currentThread().getContextClassLoader().getResource("configuration/manager/complexFieldsDeltaSchema.json");
  final Schema complexSchema=new Schema.Parser().parse(new File(schemaUrl.getPath()));
  ConfigurationProcessor processor=mock(ConfigurationProcessor.class);
  DefaultConfigurationPersistenceManager persistenceManager=new DefaultConfigurationPersistenceManager();
  persistenceManager.setConfigurationProcessor(processor);
  persistenceManager.onSchemaUpdated(complexSchema);
  GenericRecord complexDelta=new GenericData.Record(DefaultConfigurationManagerTest.getDeltaSchemaByFullName(complexSchema,"org.kaa.config.testT"));
  DefaultConfigurationManagerTest.fillComplexFullResyncDelta(complexDelta);
  byte[] rawBuffer=serializeDelta(complexDelta,complexSchema);
  final ByteBuffer complexBuffer=ByteBuffer.wrap(rawBuffer);
  EndpointObjectHash complexHash=EndpointObjectHash.fromSHA1(rawBuffer);
  ConfigurationStorage storage=mock(ConfigurationStorage.class);
  when(storage.loadConfiguration()).thenReturn(complexBuffer);
  persistenceManager.setConfigurationStorage(storage);
  persistenceManager.onConfigurationUpdated(mock(CommonRecord.class));
  assertTrue(complexHash.equals(persistenceManager.getConfigurationHash()));
  ConfigurationStorage nullStorage=mock(ConfigurationStorage.class);
  when(nullStorage.loadConfiguration()).thenReturn(null);
  persistenceManager.setConfigurationStorage(nullStorage);
  verify(processor,times(1)).processConfigurationData(complexBuffer,true);
}

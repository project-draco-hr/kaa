{
  if (profileSchemaDto == null) {
    throw new IncorrectParameterException("Can't save profile schema. Invalid profile schema object.");
  }
  String appId=profileSchemaDto.getApplicationId();
  if (isNotBlank(appId)) {
    String id=profileSchemaDto.getId();
    if (StringUtils.isBlank(id)) {
      ProfileSchema profileSchema=profileSchemaDao.findLatestByAppId(appId);
      int version=-1;
      if (profileSchema != null) {
        version=profileSchema.getVersion();
      }
      profileSchemaDto.setId(null);
      profileSchemaDto.setVersion(++version);
      profileSchemaDto.setCreatedTime(System.currentTimeMillis());
    }
 else {
      EndpointProfileSchemaDto oldProfileSchemaDto=getDto(profileSchemaDao.findById(id));
      if (oldProfileSchemaDto != null) {
        oldProfileSchemaDto.editFields(profileSchemaDto);
        profileSchemaDto=oldProfileSchemaDto;
        return getDto(profileSchemaDao.save(new ProfileSchema(profileSchemaDto)));
      }
 else {
        LOG.error("Can't find profile schema with given id [{}].",id);
        throw new IncorrectParameterException("Invalid profile schema id: " + id);
      }
    }
    return getDto(profileSchemaDao.save(new ProfileSchema(profileSchemaDto)));
  }
 else {
    throw new IncorrectParameterException("Invalid profile schema object. Incorrect application id" + appId);
  }
}

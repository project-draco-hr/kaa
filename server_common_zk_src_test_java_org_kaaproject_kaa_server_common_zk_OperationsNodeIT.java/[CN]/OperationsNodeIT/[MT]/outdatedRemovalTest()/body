{
  Timing timing=new Timing();
  TestingCluster cluster=new TestingCluster(3);
  cluster.start();
  try {
    OperationsNodeInfo endpointNodeInfo=buildOperationsNodeInfo();
    BootstrapNodeInfo bootstrapNodeInfo=buildBootstrapNodeInfo();
    BootstrapNode bootstrapNode=new BootstrapNode(bootstrapNodeInfo,cluster.getConnectString(),buildDefaultRetryPolicy());
    OperationsNodeListener mockListener=mock(OperationsNodeListener.class);
    bootstrapNode.addListener(mockListener);
    bootstrapNode.start();
    OperationsNode endpointNode=new OperationsNode(endpointNodeInfo,cluster.getConnectString(),buildDefaultRetryPolicy());
    endpointNode.start();
    timing.sleepABit();
    verify(mockListener).onNodeAdded(endpointNodeInfo);
    OperationsNodeInfo endpointNodeInfoWithGreaterTimeStarted=buildOperationsNodeInfo();
    OperationsNode endpointNodeWithGreaterTimeStarted=new OperationsNode(endpointNodeInfoWithGreaterTimeStarted,cluster.getConnectString(),buildDefaultRetryPolicy());
    endpointNodeWithGreaterTimeStarted.start();
    timing.sleepABit();
    endpointNode.close();
    timing.sleepABit();
    verify(mockListener,never()).onNodeRemoved(endpointNodeInfo);
    endpointNodeWithGreaterTimeStarted.close();
    timing.sleepABit();
    verify(mockListener).onNodeRemoved(endpointNodeInfoWithGreaterTimeStarted);
    bootstrapNode.close();
  }
  finally {
    cluster.close();
  }
}

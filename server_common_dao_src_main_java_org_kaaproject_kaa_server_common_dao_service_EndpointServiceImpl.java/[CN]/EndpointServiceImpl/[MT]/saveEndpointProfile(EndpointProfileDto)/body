{
  EndpointProfileDto profileDto=null;
  validateObject(endpointProfileDto,"Can't find endpoint profile object. Invalid endpoint profile object" + endpointProfileDto);
  byte[] keyHash=endpointProfileDto.getEndpointKeyHash();
  validateHash(keyHash,"Incorrect key hash for endpoint profile.");
  if (endpointProfileDto.getServerProfileBody() == null) {
    ServerProfileSchemaDto serverProfileSchemaDto=serverProfileService.findLatestServerProfileSchema(endpointProfileDto.getApplicationId());
    CTLSchemaDto schemaDto=ctlService.findCTLSchemaById(serverProfileSchemaDto.getCtlSchemaId());
    LOG.debug("Set latest server profile schema [{}] and default record {} for endpoint with key [{}]",serverProfileSchemaDto.getVersion(),schemaDto.getBody(),keyHash);
    endpointProfileDto.setServerProfileVersion(serverProfileSchemaDto.getVersion());
    endpointProfileDto.setServerProfileBody(schemaDto.getDefaultRecord());
  }
  if (isBlank(endpointProfileDto.getId())) {
    EndpointProfile storedProfile=endpointProfileDao.findEndpointIdByKeyHash(keyHash);
    if (storedProfile != null) {
      endpointProfileDto.setId(storedProfile.getId());
      LOG.debug("Register new endpoint profile.");
    }
  }
  profileDto=getDto(endpointProfileDao.save(endpointProfileDto));
  return profileDto;
}

{
  EndpointProfileViewDto viewDto=new EndpointProfileViewDto();
  EndpointProfileDto endpointProfileDto=endpointService.findEndpointProfileByKeyHash(Base64.decodeBase64(endpointProfileKeyHash));
  viewDto.setEndpointProfileDto(endpointProfileDto);
  String externalId=endpointProfileDto.getEndpointUserId();
  EndpointUserDto userDto=null;
  if (externalId != null) {
    userDto=endpointService.findEndpointUserById(externalId);
  }
  viewDto.setEndpointUserDto(userDto);
  String applicationId=endpointProfileDto.getApplicationId();
  int profileVersion=endpointProfileDto.getProfileVersion();
  ProfileSchemaDto schemaDto=profileService.findProfileSchemaByAppIdAndVersion(applicationId,profileVersion);
  viewDto.setProfileSchemaDto(schemaDto);
  String serverProfileSchemaId=endpointProfileDto.getServerProfileCtlSchemaId();
  if (serverProfileSchemaId != null && !serverProfileSchemaId.isEmpty()) {
    CTLSchemaDto ctlSchemaDto=ctlService.findCTLSchemaById(serverProfileSchemaId);
    ServerProfileSchemaDto serverProfileSchema=null;
    List<ServerProfileSchemaDto> serverProfileSchemas=serverProfileService.findServerProfileSchemasByAppId(applicationId);
    for (    ServerProfileSchemaDto dto : serverProfileSchemas) {
      if (dto.getCtlSchemaId().equals(serverProfileSchemaId)) {
        serverProfileSchema=dto;
      }
    }
    viewDto.setServerProfileSchemaDto(new ServerProfileSchemaViewDto(serverProfileSchema,ctlSchemaDto));
  }
  List<TopicDto> topicsByApplicationId=topicService.findTopicsByAppId(applicationId);
  List<String> endpointTopicsIDs=endpointProfileDto.getSubscriptions();
  List<TopicDto> endpointTopics=null;
  if (topicsByApplicationId != null && endpointTopicsIDs != null) {
    endpointTopics=new ArrayList<>();
    for (    TopicDto topicDto : topicsByApplicationId) {
      if (endpointTopicsIDs.contains(topicDto.getId()))       endpointTopics.add(topicDto);
    }
    viewDto.setEndpointNotificationTopics(endpointTopics);
  }
  Set<EndpointGroupDto> endpointGroups=new HashSet<>();
  List<EndpointGroupStateDto> groupStateList=endpointProfileDto.getCfGroupStates();
  if (groupStateList != null && !groupStateList.isEmpty()) {
    for (    EndpointGroupStateDto dto : groupStateList) {
      endpointGroups.add(endpointService.findEndpointGroupById(dto.getEndpointGroupId()));
    }
  }
  groupStateList=endpointProfileDto.getNfGroupStates();
  if (groupStateList != null && !groupStateList.isEmpty()) {
    for (    EndpointGroupStateDto dto : groupStateList) {
      endpointGroups.add(endpointService.findEndpointGroupById(dto.getEndpointGroupId()));
    }
  }
  List<EndpointGroupDto> groupDtoList=new ArrayList<>();
  groupDtoList.addAll(endpointGroups);
  viewDto.setGroupDtoList(groupDtoList);
  return viewDto;
}

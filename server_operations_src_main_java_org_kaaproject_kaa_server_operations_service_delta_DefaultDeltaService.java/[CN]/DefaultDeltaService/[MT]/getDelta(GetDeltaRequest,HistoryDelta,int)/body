{
  GetDeltaResponse response;
  EndpointProfileDto profile=request.getEndpointProfile();
  String endpointId="N/A";
  if (LOG.isDebugEnabled() && profile != null && profile.getEndpointKeyHash() != null) {
    endpointId=Base64Util.encode(profile.getEndpointKeyHash());
  }
  if (request.getSequenceNumber() == curAppSeqNumber) {
    LOG.debug("[{}] No changes to current application was made -> no delta",endpointId);
    return new GetDeltaResponse(GetDeltaResponseType.NO_DELTA,curAppSeqNumber);
  }
  AppVersionKey appConfigVersionKey=new AppVersionKey(request.getApplicationToken(),profile.getConfigurationVersion());
  List<EndpointGroupStateDto> endpointGroups=historyDelta.getEndpointGroupStates();
  if (historyDelta.isConfigurationChanged()) {
    boolean resync=request.isFirstRequest() || request.isResyncOnly();
    if (!resync && !request.getConfigurationHash().binaryEquals(profile.getConfigurationHash())) {
      resync=true;
      if (profile.getConfigurationHash() != null && LOG.isWarnEnabled()) {
        String serverHash="";
        String clientHash="";
        if (profile.getConfigurationHash() != null) {
          serverHash=MessageEncoderDecoder.bytesToHex(profile.getConfigurationHash());
        }
        if (request.getConfigurationHash() != null) {
          clientHash=MessageEncoderDecoder.bytesToHex(request.getConfigurationHash().getData());
        }
        LOG.warn("[{}] Configuration hash mismatch! server {}, client {}",endpointId,serverHash,clientHash);
      }
    }
    DeltaCacheKey deltaKey;
    if (resync) {
      deltaKey=new DeltaCacheKey(appConfigVersionKey,endpointGroups,null,request.isResyncOnly());
      LOG.debug("[{}] Building resync delta key {}",endpointId,deltaKey);
    }
 else {
      deltaKey=new DeltaCacheKey(appConfigVersionKey,endpointGroups,request.getConfigurationHash());
      LOG.debug("[{}] Building regular delta key {}",endpointId,deltaKey);
    }
    DeltaCacheEntry deltaCacheEntry=getDelta(endpointId,deltaKey);
    byte[] configurationHash=deltaCacheEntry.getHash().getData();
    if (profile.getConfigurationHash() == null && request.getConfigurationHash() != null && request.getConfigurationHash().binaryEquals(configurationHash)) {
      response=new GetDeltaResponse(GetDeltaResponseType.NO_DELTA,curAppSeqNumber);
    }
 else {
      if (resync) {
        response=new GetDeltaResponse(GetDeltaResponseType.CONF_RESYNC,curAppSeqNumber,deltaCacheEntry.getDelta());
      }
 else {
        if (deltaCacheEntry.getDelta().hasChanges()) {
          response=new GetDeltaResponse(GetDeltaResponseType.DELTA,curAppSeqNumber,deltaCacheEntry.getDelta());
        }
 else {
          LOG.debug("[{}] Delta has no changes -> no delta",endpointId);
          response=new GetDeltaResponse(GetDeltaResponseType.NO_DELTA,curAppSeqNumber);
        }
      }
    }
    profile.setConfigurationHash(configurationHash);
  }
 else {
    LOG.debug("[{}] No changes to current application group configurations was maid -> no delta",endpointId);
    response=new GetDeltaResponse(GetDeltaResponseType.NO_DELTA,curAppSeqNumber);
  }
  LOG.debug("[{}] Response: {}",endpointId,response);
  return response;
}

{
  RobotEmulator emu=new RobotEmulator(labyrinth,getInitialPosition(),getInitialDirection(),null);
  assertNotNull(emu);
  final Object obj=new Object();
  OK=false;
  emu.registerStateCallback(new StateCallback(){
    @Override public void onDisconnected(){
    }
    @Override public void onConnected(    String deviceName){
synchronized (obj) {
        OK=true;
        obj.notify();
      }
    }
  }
);
  try {
    emu.start();
  }
 catch (  Exception e) {
    Assert.assertTrue(false);
  }
synchronized (obj) {
    try {
      obj.wait(2000);
      assertEquals(true,OK);
    }
 catch (    InterruptedException e) {
      fail("Creator wait failed");
    }
  }
  emu.registerErrorCallback(new ErrorCallback(){
    @Override public void error(    Exception exception){
      exception.printStackTrace();
      fail(exception.toString());
    }
  }
);
  final Object objSync=new Object();
  emu.registerMoveForwardCallback(new MoveForwardCallback(){
    @Override public void complete(    OperationStatus status){
      if (status == OperationStatus.FAILED) {
        fail("MoveForward command failed");
      }
synchronized (objSync) {
        objSync.notify();
      }
    }
  }
);
  Cell posBefore=emu.getCurrentPosition();
  Cell posAfter=getReadyForMoveForward(emu);
  emu.moveForward(false);
synchronized (objSync) {
    try {
      objSync.wait(emu.getCommandTimeout() + emu.getTimeoutDeviation());
      assertEquals(posAfter.getX(),emu.getCurrentPosition().getX());
      assertEquals(posAfter.getY(),emu.getCurrentPosition().getY());
    }
 catch (    InterruptedException e) {
      fail(e.toString());
    }
  }
  emu.registerMoveForwardCallback(new MoveForwardCallback(){
    @Override public void complete(    OperationStatus status){
      if (status == OperationStatus.FAILED) {
        fail("MoveForward command failed");
      }
synchronized (objSync) {
        objSync.notify();
      }
    }
  }
);
  emu.moveBackward();
synchronized (objSync) {
    try {
      objSync.wait(emu.getCommandTimeout() + emu.getTimeoutDeviation());
      assertEquals(posBefore.getX(),emu.getCurrentPosition().getX());
      assertEquals(posBefore.getY(),emu.getCurrentPosition().getY());
    }
 catch (    InterruptedException e) {
      fail(e.toString());
    }
  }
}

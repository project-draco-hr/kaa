{
  if (subscribers == null) {
    LOG.warn("Failed to update topic subsciptions: null subscribers");
    throw new IllegalArgumentException("NUll subscribers");
  }
  List<SubscriptionCommand> subscriptionUpdate=new LinkedList<>();
  for (  Map.Entry<String,List<NotificationListenerInfo>> cursor : subscribers.entrySet()) {
    Topic listenerTopic=findTopicById(cursor.getKey());
synchronized (optionalListeners) {
      List<NotificationListener> listeners=optionalListeners.get(cursor.getKey());
      if (cursor.getValue() != null) {
        for (        NotificationListenerInfo subscriberInfo : cursor.getValue()) {
          if (subscriberInfo.getAction() == NotificationListenerInfo.Action.ADD) {
            if (listeners == null) {
              listeners=new LinkedList<NotificationListener>();
              optionalListeners.put(listenerTopic.getId(),listeners);
            }
            if (listeners.isEmpty() && listenerTopic.getSubscriptionType() == SubscriptionType.OPTIONAL) {
              subscriptionUpdate.add(new SubscriptionCommand(listenerTopic.getId(),SubscriptionCommandType.ADD));
            }
            if (subscriberInfo.getListener() != null && !listeners.contains(subscriberInfo.getListener())) {
              listeners.add(subscriberInfo.getListener());
            }
          }
 else           if (listeners != null) {
            listeners.remove(subscriberInfo.getListener());
            if (listeners.isEmpty() && listenerTopic.getSubscriptionType() == SubscriptionType.OPTIONAL) {
              subscriptionUpdate.add(new SubscriptionCommand(listenerTopic.getId(),SubscriptionCommandType.REMOVE));
            }
          }
        }
      }
    }
  }
  if (!subscriptionUpdate.isEmpty()) {
    updateSubscriptionInfo(subscriptionUpdate);
  }
  if (transport != null) {
    transport.sync();
  }
}

{
  DefaultConfigurationManager manager=new DefaultConfigurationManager();
  ConfigurationReceiver receiver=mock(ConfigurationReceiver.class);
  manager.subscribeForConfigurationUpdates(receiver);
  URL schemaUrl=Thread.currentThread().getContextClassLoader().getResource("configuration/manager/arrayFieldsDeltaSchema.json");
  Schema schema=new Schema.Parser().parse(new File(schemaUrl.getPath()));
  GenericRecord delta=new GenericData.Record(getDeltaSchemaByFullName(schema,"org.kaa.config.testT"));
  fillArrayFullResyncDelta(delta);
  manager.onDeltaReceived(0,delta,true);
  manager.onConfigurationProcessed();
  CommonRecord rootConfig=manager.getConfiguration();
  List<CommonValue> configArray=rootConfig.getField("testField1").getArray().getList();
  assertTrue(rootConfig.getField("testField1").isArray());
  assertEquals(3,configArray.size());
  assertEquals(new Integer(1),configArray.get(0).getRecord().getField("testField2").getInteger());
  assertEquals(new Integer(2),configArray.get(1).getRecord().getField("testField2").getInteger());
  assertEquals(new Integer(3),configArray.get(2).getRecord().getField("testField2").getInteger());
  GenericRecord itemRecord2=new GenericData.Record(getDeltaSchemaByFullName(schema,"org.kaa.config.testRecordItemT"));
  fillArrayItemUpdateDelta(itemRecord2);
  manager.onDeltaReceived(1,itemRecord2,false);
  manager.onConfigurationProcessed();
  rootConfig=manager.getConfiguration();
  configArray=rootConfig.getField("testField1").getArray().getList();
  assertEquals(new Integer(1),configArray.get(0).getRecord().getField("testField2").getInteger());
  assertEquals(new Integer(22),configArray.get(1).getRecord().getField("testField2").getInteger());
  assertEquals(new Integer(3),configArray.get(2).getRecord().getField("testField2").getInteger());
  fillArrayItemRemoveDelta(delta);
  manager.onDeltaReceived(0,delta,false);
  manager.onConfigurationProcessed();
  rootConfig=manager.getConfiguration();
  configArray=rootConfig.getField("testField1").getArray().getList();
  assertEquals(2,configArray.size());
  assertEquals(new Integer(22),configArray.get(0).getRecord().getField("testField2").getInteger());
  assertEquals(new Integer(3),configArray.get(1).getRecord().getField("testField2").getInteger());
  fillArrayResetDelta(delta);
  manager.onDeltaReceived(0,delta,false);
  manager.onConfigurationProcessed();
  rootConfig=manager.getConfiguration();
  configArray=rootConfig.getField("testField1").getArray().getList();
  assertTrue(configArray.isEmpty());
  verify(receiver,times(4)).onConfigurationUpdated(any(CommonRecord.class));
}

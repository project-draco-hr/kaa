{
  DefaultConfigurationManager manager=new DefaultConfigurationManager();
  ConfigurationReceiver receiver=mock(ConfigurationReceiver.class);
  manager.subscribeForConfigurationUpdates(receiver);
  URL schemaUrl=Thread.currentThread().getContextClassLoader().getResource("configuration/manager/complexFieldsDeltaSchema.json");
  Schema schema=new Schema.Parser().parse(new File(schemaUrl.getPath()));
  GenericRecord delta=new GenericData.Record(getDeltaSchemaByFullName(schema,"org.kaa.config.testT"));
  fillComplexFullResyncDelta(delta);
  manager.onDeltaReceived(0,delta,true);
  CommonRecord rootConfig=manager.getConfiguration();
  manager.onConfigurationProcessed();
  assertTrue(rootConfig.hasField("testField1"));
  assertEquals("abc",rootConfig.getField("testField1").getString());
  assertTrue(rootConfig.getField("testField1").isString());
  assertFalse(rootConfig.getField("testField1").isInteger());
  assertTrue(rootConfig.hasField("testField2"));
  assertTrue(rootConfig.getField("testField2").isRecord());
  assertTrue(rootConfig.getField("testField2").getRecord().getField("testField3").isInteger());
  assertEquals(new Integer(456),rootConfig.getField("testField2").getRecord().getField("testField3").getInteger());
  fillComplexPartialDelta(delta);
  manager.onDeltaReceived(0,delta,false);
  rootConfig=manager.getConfiguration();
  manager.onConfigurationProcessed();
  verify(receiver,times(2)).onConfigurationUpdated(any(CommonRecord.class));
  assertTrue(rootConfig.hasField("testField1"));
  assertEquals("abc",rootConfig.getField("testField1").getString());
  assertTrue(rootConfig.getField("testField1").isString());
  assertTrue(rootConfig.hasField("testField2"));
  assertTrue(rootConfig.getField("testField2").isRecord());
  assertTrue(rootConfig.getField("testField2").getRecord().getField("testField3").isInteger());
  assertEquals(new Integer(654),rootConfig.getField("testField2").getRecord().getField("testField3").getInteger());
}
